# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
Index: misc/unix/errorcodes.c
===================================================================
--- misc/unix/errorcodes.c	(revision 408977)
+++ misc/unix/errorcodes.c	(working copy)
@@ -247,15 +247,35 @@
     apr_size_t len=0, i;
 
 #ifndef NETWARE
-    len = FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM 
+#if !defined(_WIN32_WCE)
+    len = FormatMessageA(FORMAT_MESSAGE_FROM_SYSTEM 
                       | FORMAT_MESSAGE_IGNORE_INSERTS,
                         NULL,
                         errcode,
                         MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), /* Default language */
-                        (LPTSTR) buf,
+                        (LPSTR) buf,
                         (DWORD)bufsize,
                         NULL);
+#else
+    len = FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM 
+                      | FORMAT_MESSAGE_IGNORE_INSERTS,
+                        NULL,
+                        errcode,
+                        LOCALE_INVARIANT,
+                        (LPTSTR) buf,
+                        (DWORD) (bufsize/sizeof(TCHAR)),
+                        NULL);
+    //
+    //  compact to US-ASCII, replace any non US-ASCII with '?'
+    for(i = 0; i <= len; i++) {
+        if (((TCHAR*) buf)[i] < 0x80) {
+            buf[i] = (char) ((TCHAR*) buf)[i];
+        } else {
+            buf[i] = '?';
+        }
+    }
 #endif
+#endif
 
     if (!len) {
         for (i = 0; gaErrorList[i].msg; ++i) {
